<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XUPERLIST TV</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Roboto', sans-serif;
            background-color: #121212;
            color: #ffffff;
        }
        .container {
            display: flex;
            height: 100%;
            overflow: hidden;
            flex-direction: row;
            background-color: #181818;
        }
        .sidebar {
            width: 250px;
            background-color: #1e1e1e;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            max-height: calc(100vh - 20px);
            border-right: 1px solid #444;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }
        .epg-guide {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        .epg-current {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #00ff00;
        }
        .epg-next {
            font-size: 16px;
            color: #ffffff;
            margin-top: 10px;
        }
        .epg-time {
            font-size: 14px;
            color: #888888;
            margin-top: 5px;
        }
        .video-container {
            position: relative;
            height: calc(100vh - 180px);
            overflow: hidden;
            background-color: #000;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            border: 2px solid #444;
        }
        #videoPlayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 10px;
        }
        .channel-item {
            padding: 12px;
            margin-bottom: 10px;
            background-color: #2a2a2a;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            display: flex;
            align-items: center;
        }
        .channel-item:hover {
            background-color: #3a3a3a;
            transform: scale(1.02);
        }
        .channel-item img {
            width: 30px;
            height: 30px;
            margin-right: 10px;
            border-radius: 5px;
            object-fit: contain;
            background-color: #000;
        }
        .channel-group {
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #ffffff;
            font-size: 20px;
            margin-bottom: 10px;
        }
        #logo-container {
            height: 60px;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #logo-container img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }
        #searchBox {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #444;
            background-color: #2a2a2a;
            color: #fff;
            box-sizing: border-box;
            font-size: 16px;
        }
        #searchBox::placeholder {
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>XUPERLIST TV(Activa vpn)</h2>
            <div id="logo-container">
    <img src="https://i.postimg.cc/zG6Rp5Fv/IMG-20250728-223605-929.jpg" alt="Mi Logo">
</div>

            <input type="text" id="searchBox" placeholder="Buscar canales...">
            <div id="channelList"></div>
        </div>
        <div class="main-content">
            <div class="epg-guide">
                <div id="epgCurrent" class="epg-current">Loading current program...</div>
                <div id="epgNext" class="epg-next">Loading next program...</div>
                <div id="epgTime" class="epg-time">Loading times...</div>
            </div>
            <div class="video-container">
                <video
                    id="videoPlayer"
                    controls
                    autoplay
                    preload="auto"
                ></video>
                <div id="loadingIndicator" class="loading-indicator">Loading...</div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        let channels = [];
        const channelGroups = {};
        let hls = null;
        let url;
        const channelListUrl = 'https://raw.githubusercontent.com/miltonja/PRIVADA-TOTAL-JULIO-2025/main/M3U2-PREMIUM%20SEPTIEMBRE%20ACTIVA.m3u8';
        
        const epgUrl = 'https://iptv-org.github.io/epg/guides/global.xml';
        let epgData = {};

        function fetchM3U() {
            console.log('Fetching channel list...');
            fetch(channelListUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(data => {
                    console.log('Channel list data received:', data);
                    if (channelListUrl.endsWith('.m3u') || channelListUrl.endsWith('.m3u8')) {
                        parseM3U(data);
                    } else if (channelListUrl.endsWith('.txt')) {
                        parseTxt(data);
                    }
                    fetchEPG();
                })
                .catch(error => {
                    console.error('Error fetching channel list:', error);
                    alert('Error loading channel list. Please check the console for details.');
                });
        }
        function parseM3U(data) {
            console.log('Parsing M3U data...');
            const lines = data.split('\n');
            let currentChannel = {};
            lines.forEach(line => {
                if (line.startsWith('#EXTINF:')) {
                    const titleMatch = line.match(/,([^,]+)$/);
                    currentChannel.title = titleMatch ? titleMatch[1].trim().replace(/\(.*?\)/g, '').trim() : 'Untitled Channel';
                    const tvgLogoMatch = line.match(/tvg-logo="([^"]+)"/);
                    currentChannel.logo = tvgLogoMatch ? tvgLogoMatch[1] : '';
                    const tvgIdMatch = line.match(/tvg-id="([^"]+)"/);
                    currentChannel.tvgId = tvgIdMatch ? tvgIdMatch[1] : '';
                } else if (line.trim() !== '' && !line.startsWith('#')) {
                    currentChannel.url = line.trim();
                    channels.push(currentChannel);
                    currentChannel = {};
                }
            });
            console.log('Channels parsed:', channels);
            displayChannels();
        }
        function parseTxt(data) {
            console.log('Parsing TXT data...');
            const lines = data.split('\n');
            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const url = parts[0].trim();
                    const title = parts[1].trim();
                    const logo = parts[2] ? parts[2].trim() : '';
                    if (url && title) {
                        channels.push({
                            title: title,
                            url: url,
                            logo: logo
                        });
                    }
                }
            });
            console.log('Channels parsed from TXT:', channels);
            displayChannels();
        }
        function fetchEPG() {
            console.log('Fetching EPG data...');
            fetch(epgUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(data => {
                    console.log('EPG data received:', data);
                    parseEPG(data);
                })
                .catch(error => {
                    console.error('Error fetching EPG file:', error);
                    console.log('EPG data not available. Continuing without EPG information.');
                });
        }
        function parseEPG(data) {
            try {
                const parser = new DOMParser();
                const xml = parser.parseFromString(data, 'text/xml');
                const programmes = xml.getElementsByTagName('programme');
                epgData = {};
                Array.from(programmes).forEach(programme => {
                    const channelId = programme.getAttribute('channel');
                    if (!epgData[channelId]) {
                        epgData[channelId] = [];
                    }
                    epgData[channelId].push({
                        start: programme.getAttribute('start'),
                        stop: programme.getAttribute('stop'),
                        title: programme.getElementsByTagName('title')[0]?.textContent || 'Unknown',
                        desc: programme.getElementsByTagName('desc')[0]?.textContent || 'No description available',
                        category: Array.from(programme.getElementsByTagName('category'))
                            .map(cat => cat.textContent)
                            .join(', ') || 'Unknown',
                    });
                });
                console.log('EPG data parsed successfully');
                displayChannels();
            } catch (error) {
                console.error('Error parsing EPG data:', error);
            }
        }
        function displayChannels(filteredChannels = channels) {
            const channelList = document.getElementById('channelList');
            channelList.innerHTML = '';
            filteredChannels.forEach(channel => {
                const channelItem = document.createElement('div');
                channelItem.className = 'channel-item';
                channelItem.onclick = () => playChannel(channel.url, channel.tvgId);
                
                if (channel.logo) {
                    const channelLogo = document.createElement('img');
                    channelLogo.src = channel.logo;
                    channelLogo.alt = `${channel.title} logo`;
                    channelItem.appendChild(channelLogo);
                }
                const channelTitle = document.createElement('span');
                channelTitle.textContent = channel.title;
                channelItem.appendChild(channelTitle);
                
                channelList.appendChild(channelItem);
            });
        }
        document.getElementById('searchBox').addEventListener('keyup', (event) => {
            const searchText = event.target.value.toLowerCase();
            const filteredChannels = channels.filter(channel => 
                channel.title.toLowerCase().includes(searchText)
            );
            displayChannels(filteredChannels);
        });
        function updateEPGDisplay(tvgId) {
            const epgCurrent = document.getElementById('epgCurrent');
            const epgNext = document.getElementById('epgNext');
            const epgTime = document.getElementById('epgTime');
            const now = new Date();
            const programs = epgData[tvgId] || [];
            
            let currentProgram = null;
            let nextProgram = null;
            programs.sort((a, b) => new Date(a.start) - new Date(b.start));
            for (let i = 0; i < programs.length; i++) {
                const start = new Date(programs[i].start);
                const stop = new Date(programs[i].stop);
                if (now >= start && now < stop) {
                    currentProgram = programs[i];
                    if (programs[i + 1]) {
                        nextProgram = programs[i + 1];
                    }
                    break;
                }
            }
            if (currentProgram) {
                epgCurrent.textContent = currentProgram.title;
                epgNext.textContent = `Siguiente: ${nextProgram ? nextProgram.title : 'No hay información'}`;
                
                const options = {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                };
                
                const start = new Date(currentProgram.start);
                const end = new Date(currentProgram.stop);

                let timezoneOffset = '';
                if (currentProgram.start.endsWith('Z')) {
                    timezoneOffset = ' (UTC)';
                } else {
                    const match = currentProgram.start.match(/([+-]\d{4})/);
                    if (match) {
                        const offset = match[1];
                        timezoneOffset = ` (UTC${offset.slice(0, 3)}:${offset.slice(3)})`;
                    } else {
                         timezoneOffset = ' (CET)';
                    }
                }
                
                const startStr = start.toLocaleTimeString('es-ES', options);
                const endStr = end.toLocaleTimeString('es-ES', options);

                epgTime.textContent = `Horario: ${startStr} - ${endStr}${timezoneOffset}`;

            } else {
                epgCurrent.textContent = 'No hay información del programa actual.';
                epgNext.textContent = 'Siguiente: No hay información';
                const nowES = now.toLocaleTimeString('es-ES', { timeZone: 'Europe/Madrid', hour: '2-digit', minute: '2-digit', hour12: false });
                epgTime.textContent = `Hora actual: ${nowES} (CET)`;
            }
        }
        function playChannel(url, tvgId) {
            const videoPlayer = document.getElementById('videoPlayer');
            const loadingIndicator = document.getElementById('loadingIndicator');
            videoPlayer.muted = false;
            videoPlayer.volume = 1;
            if (hls) {
                try {
                    hls.destroy();
                } catch (error) {
                    console.error('Error destroying previous HLS player:', error);
                }
                hls = null;
            }
            videoPlayer.src = '';
            videoPlayer.pause();
            videoPlayer.currentTime = 0;
            videoPlayer.load();
            updateEPGDisplay(tvgId);
            console.log('Attempting to play channel. URL:', url);
            let secureUrl = url.replace(/^http:/, 'https:');
            if (!secureUrl.startsWith('https://') && !secureUrl.startsWith('//')) {
                secureUrl = 'https://' + secureUrl;
            }
            console.log('Final URL after processing:', secureUrl);
            if (Hls.isSupported()) {
                hls = new Hls({
                    maxMaxBufferLength: 60,
                    maxBufferLength: 60,
                    liveSyncDurationCount: 3,
                    liveMaxLatencyDurationCount: 6,
                    maxRetry: 5,
                    retryDelay: 1000,
                    maxRetryDelay: 5000,
                    capLevelToPlayerSize: true,
                    enableWorker: true,
                    enableSoftwareAES: true,
                    xhrSetup: function(xhr, url) {
                        xhr.withCredentials = false;
                        xhr.timeout = 10000;
                    }
                });
                let playbackTimeout;
                let retryCount = 0;
                const maxRetries = 3;
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error('HLS error:', data);
                    if (data.fatal) {
                        try {
                            hls.destroy();
                        } catch (error) {
                            console.error('Error destroying HLS player:', error);
                        }
                        hls = null;
                        videoPlayer.src = secureUrl;
                        videoPlayer.play().catch(error => {
                            console.error('Native playback error:', error);
                            const errorMessage = error.message || 'Unknown error';
                            alert(`Unable to play this channel. Error: ${errorMessage}. Please try another one.`);
                        });
                    }
                });
                hls.on(Hls.Events.MANIFEST_LOADING, () => {
                    console.log('Loading manifest...');
                    if (playbackTimeout) {
                        clearTimeout(playbackTimeout);
                    }
                    playbackTimeout = setTimeout(() => {
                        console.error('Playback timeout occurred');
                        if (hls) {
                            try {
                                hls.destroy();
                            } catch (error) {
                                console.error('Error destroying HLS player:', error);
                            }
                            hls = null;
                        }
                        videoPlayer.src = '';
                        alert('Playback timed out. Please try another channel.');
                    }, 10000);
                });
                hls.on(Hls.Events.MANIFEST_LOADED, (event, data) => {
                    console.log('Manifest loaded successfully:', data);
                });
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    console.log('Manifest parsed successfully');
                    if (playbackTimeout) {
                        clearTimeout(playbackTimeout);
                    }
                    videoPlayer.play().catch(error => {
                        console.error('Playback error:', error);
                        const errorMessage = error.message || 'Unknown error';
                        alert(`Unable to play this channel. Error: ${errorMessage}. Please try another one.`);
                    });
                });
                hls.on(Hls.Events.LEVEL_LOADING, (event, data) => {
                    console.log('Loading level:', data);
                });
                hls.on(Hls.Events.LEVEL_LOADED, (event, data) => {
                    console.log('Level loaded:', data);
                });
                hls.loadSource(secureUrl);
                hls.attachMedia(videoPlayer);
            } else {
                videoPlayer.src = secureUrl;
                videoPlayer.play().catch(error => {
                    console.error('Native playback error:', error);
                    const errorMessage = videoPlayer.error?.message || 'Unknown error';
                    alert(`Unable to play this channel. Error: ${errorMessage}. Please try another one.`);
                });
            }
            videoPlayer.addEventListener('error', (event) => {
                console.error('Video error:', videoPlayer.error);
                const errorMessage = videoPlayer.error?.message || 'Unknown error';
                alert(`Unable to play this channel. Error: ${errorMessage}. Please try another one.`);
            });
            videoPlayer.addEventListener('stalled', () => {
                console.error('Video stalled');
                alert('Video playback is stalled. Please try another channel.');
            });
            videoPlayer.addEventListener('waiting', () => {
                console.log('Video waiting for data');
                setTimeout(() => {
                    loadingIndicator.classList.add('show');
                }, 500);
            });
            videoPlayer.addEventListener('playing', () => {
                loadingIndicator.classList.remove('show');
            });
            videoPlayer.addEventListener('error', () => {
                loadingIndicator.classList.remove('show');
            });
            videoPlayer.addEventListener('ended', () => {
                loadingIndicator.classList.remove('show');
            });
            let timeoutId;
            const startTimeout = () => {
                timeoutId = setTimeout(() => {
                    if (videoPlayer.paused && !videoPlayer.ended) {
                        console.error('Playback timeout');
                        alert('Playback timed out. Please try another channel.');
                        if (hls) {
                            try {
                                hls.destroy();
                            } catch (error) {
                                console.error('Error destroying HLS player:', error);
                            }
                            hls = null;
                        }
                        videoPlayer.src = '';
                    }
                }, 10000);
            };
            videoPlayer.addEventListener('playing', () => {
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
            });
            videoPlayer.addEventListener('pause', () => {
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
            });
            startTimeout();
        }
        document.addEventListener('DOMContentLoaded', fetchM3U);
    </script>
</body>
</html>

